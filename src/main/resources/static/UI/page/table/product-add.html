<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.8/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <script src="../../js/jquery-1.9.1.min.js"></script>
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>
<div class="layui-form layuimini-form" id="add_area">
    <form id="form-add-product">
        <div class="layui-form-item">
            <label class="layui-form-label required">商品编号</label>
            <div class="layui-input-block">
                <input type="text" id="id" name="id" lay-verify="required" lay-reqtext="商品编号不能为空"
                       placeholder="" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">商品名</label>
            <div class="layui-input-block">
                <input type="text" id="title" name="title" lay-verify="required" lay-reqtext="商品名不能为空"
                       placeholder="" value="" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label required">商品类别</label>
            <div class="layui-input-block">
                <input type="text" id="category" name="category" lay-verify="required" lay-reqtext="商品类别不能为空"
                       placeholder="" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">分类</label>
            <div class="layui-input-inline">
                <select id="kind1" lay-filter="kind1" name="kind1">
                    <option value="">请选择省</option>
                    <option value="浙江">浙江省</option>
                    <option value="你的工号">江西省</option>
                    <option value="你最喜欢的老师">福建省</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="kind2" lay-filter="kind2" name="kind2">
                    <option value="">请选择市</option>
                    <option value="杭州">杭州</option>
                    <option value="宁波">宁波</option>
                    <option value="温州">温州</option>
                    <option value="温州">台州</option>
                    <option value="温州">绍兴</option>
                </select>
            </div>

        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">卖点</label>
            <div class="layui-input-block">
                <input type="text" name="sellPoint" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">价格（元）</label>
            <div class="layui-input-block">
                <input type="text" name="price" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
                <input type="text" name="num" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">宽度</label>
                <div class="layui-input-inline">
                    <input type="text" name="width" value="" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">深度</label>
                <div class="layui-input-inline">
                    <input type="text" name="depth" value="" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">高度</label>
                <div class="layui-input-inline">
                    <input type="text" name="height" value="" class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">单位：cm</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-inline">
                <select name="status" lay-verify="required">
                    <option value=""></option>
                    <option value="0">下架</option>
                    <option value="1">在售</option>
                </select>
            </div>
        </div>


        <div class="layui-form-item">
            <div class="layui-input-block">
                <button id="btn-add-product" class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn_product">确认保存
                </button>
            </div>
        </div>
    </form>

    <form id = "form-add-picture">

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>商品封面图片上传</legend>
        </fieldset>

        <div class="layui-upload layui-col-md-offset1">
            <button type="button" class="layui-btn" id="test1">上传图片</button>
            <div class="layui-upload-list" style="width: 200px;">
                <img class="layui-upload-img" style="width: 200px;" id="demo1">
                <p id="demoText"></p>
            </div>
            <div style="width: 95px;">
                <div class="layui-progress layui-progress-big" lay-showpercent="yes" lay-filter="demo">
                    <div class="layui-progress-bar" lay-percent=""></div>
                </div>
            </div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>商品预览图片上传</legend>
        </fieldset>

        <div class="layui-upload layui-col-md-offset1">
            <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button>
            <div class="layui-upload-list" style="max-width: 1000px;">
                <table class="layui-table">
                    <colgroup>
                        <col>
                        <col width="150">
                        <col width="260">
                        <col width="150">
                    </colgroup>
                    <thead>
                    <tr>
                        <th>文件名</th>
                        <th>大小</th>
                        <th>上传进度</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="demoList"></tbody>
                </table>
            </div>
            <button type="button" lay-filter="saveBtn_picture_1"  class="layui-btn" id="testListAction">开始上传</button>
        </div>
        <div style="margin-top: 100px">
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>商品详情图片上传</legend>
        </fieldset>
        <div class="layui-upload layui-col-md-offset1">
            <button type="button" class="layui-btn layui-btn-normal" id="testList_2">选择多文件</button>
            <div class="layui-upload-list" style="max-width: 1000px;">
                <table class="layui-table">
                    <colgroup>
                        <col>
                        <col width="150">
                        <col width="260">
                        <col width="150">
                    </colgroup>
                    <thead>
                    <tr>
                        <th>文件名</th>
                        <th>大小</th>
                        <th>上传进度</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="demoList_2"></tbody>
                </table>
            </div>
            <button type="button" lay-filter="saveBtn_picture_1"  class="layui-btn" id="testListAction_2">开始上传商品详情图片</button>


            <div class="layui-col-md-offset5" style="margin-top: 100px">
                <button type="button" lay-filter="close" lay-submit class="layui-btn layui-btn-lg">关闭</button>
            </div>

        </div>


    </form>

</div>
<script src="../../lib/layui-v2.8/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../js/jquery-getUrlParam.js"></script>
<script>


    let id;//商品编号
    layui.use(['upload', 'element', 'form'], function () {
        var form = layui.form,
            layer = layui.layer;

        var $ = layui.jquery
            ,upload = layui.upload
            ,element = layui.element;

            $("#form-add-picture").hide();
            form_add = $("#form-add-product");




        $("#kind1").empty();
        $("#kind2").empty();

        showProvinceList();
        $("#kind2").append(defaultOption);

        form.on('select(kind1)', function (data) {
            console.log("省改变监听");
            showCityList();
        });

        //监听提交
        form.on('submit(saveBtn_product)', function (data) {
            id = $("#id").val();
            console.log("1商品："+id);
            $.ajax({
                url: "/products/add_product",
                type: "POST",
                data: form_add.serialize(),
                dataType: "JSON",
                success: function (json) {
                    if (json.state == 200) {
                        // alert("新增收货地址成功！");
                        var index = layer.alert("添加成功", {
                            title: '提示'
                        }, function () {
                            // 关闭弹出层
                            id = $("#id").val();
                            console.log("2商品："+id);
                            layer.close(index);
                            $("#form-add-product").hide();
                            $("#form-add-picture").show();
                            fileupload(id);
                            // var iframeIndex = parent.layer.getFrameIndex(window.name);
                            // parent.layer.close(iframeIndex);

                        });

                    } else {
                        alert("新增收货地址失败！" + json.message);
                    }
                },
                error: function (xhr) {
                    alert("您的登录信息已经过期，请重新登录！HTTP响应码：" + xhr.status);
                    location.href = "login.html";
                }
            });


            return false;
        });



        form.on('submit(close)',function () {
            console.log("关闭窗口");
            var iframeIndex = parent.layer.getFrameIndex(window.name);
            parent.layer.close(iframeIndex);
        });


        function showProvinceList() {

            $("#kind1").append(defaultOption);
            $.ajax({
                url: "/product_kind",
                type: "GET",
                data: "parent=86",
                dataType: "JSON",
                success: function (json) {
                    if (json.state == 200) {
                        let list = json.data;
                        console.log("count=" + list.length);
                        for (let i = 0; i < list.length; i++) {
                            console.log(list[i].name);
                            let option = '<option value="' + list[i].code + '">' + list[i].name + '</option>';
                            $("#kind1").append(option);
                            form.render('select');
                        }
                    }
                }
            });

        }

        function showCityList() {

            let parent = $("#kind1").val();
            $("#kind2").empty();
            $("#kind2").append(defaultOption);



            $.ajax({
                url: "/product_kind",
                type: "GET",
                data: "parent=" + parent,
                dataType: "JSON",
                success: function (json) {
                    if (json.state == 200) {
                        let list = json.data;
                        console.log("count=" + list.length);
                        for (let i = 0; i < list.length; i++) {
                            console.log(list[i].name);
                            let option = '<option value="' + list[i].code + '">' + list[i].name + '</option>';
                            $("#kind2").append(option);
                            form.render('select');
                        }
                    }
                }
            });
        }








        // 文件上传
        function fileupload(id){

            $.ajax({
                url: '/picture/'+id+'/delete',
                type: "GET",
                dataType: "JSON",
                success: function (json) {
                    console.log("文件删除成功");
                }
            });


            //常规使用 - 普通图片上传
            var uploadInst = upload.render({
                elem: '#test1'
                ,url: '/picture/'+id+'/0' //此处用的是第三方的 http 请求演示，实际使用时改成您自己的上传接口即可。
                , exts: 'jpg|png|gif|bmp|jpeg|avif|webp'
                ,before: function(obj){
                    //预读本地文件示例，不支持ie8
                    obj.preview(function(index, file, result){
                        $('#demo1').attr('src', result); //图片链接（base64）
                    });

                    element.progress('demo', '0%'); //进度条复位
                    layer.msg('上传中', {icon: 16, time: 0});
                }
                ,done: function(res){
                    //如果上传失败
                    if(res.code > 0){
                        return layer.msg('上传失败');
                    }
                    //上传成功的一些操作
                    //……
                    $('#demoText').html(''); //置空上传失败的状态
                }
                ,error: function(){
                    //演示失败状态，并实现重传
                    var demoText = $('#demoText');
                    demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                    demoText.find('.demo-reload').on('click', function(){
                        uploadInst.upload();
                    });
                }
                //进度条
                ,progress: function(n, elem, e){
                    element.progress('demo', n + '%'); //可配合 layui 进度条元素使用
                    if(n == 100){
                        layer.msg('上传完毕', {icon: 1});
                    }
                }
            });


            //演示多文件列表
            console.log("商品："+id);
            var uploadListIns = upload.render({
                elem: '#testList'
                , elemList: $('#demoList') //列表元素对象
                , url: '/picture/'+id+'/1' //上传接口
                // , url: 'https://httpbin.org/post' //测试上传接口
                , accept: 'file'
                , exts: 'jpg|png|gif|bmp|jpeg|avif|webp'
                , multiple: true
                , number: 4
                , auto: false
                , bindAction: '#testListAction'
                , choose: function (obj) {
                    let i = 1;
                    console.log(obj);
                    var that = this;
                    var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                    //读取本地文件
                    obj.preview(function (index, file, result) {
                        console.log('文件i'+i)
                        i = i+1;
                        // obj.resetFile(index, file, '1.jpg')
                        var tr = $(['<tr id="upload-' + index + '">'
                            , '<td>' + file.name + '</td>'
                            , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                            , '<td><div class="layui-progress" lay-filter="progress-demo-' + index + '"><div class="layui-progress-bar" lay-percent=""></div></div></td>'
                            , '<td>'
                            , '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                            , '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                            , '</td>'
                            , '</tr>'].join(''));

                        //单个重传
                        tr.find('.demo-reload').on('click', function () {
                            obj.upload(index, file);
                        });

                        //删除
                        tr.find('.demo-delete').on('click', function () {
                            delete files[index]; //删除对应的文件
                            tr.remove();
                            uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                        });

                        that.elemList.append(tr);
                        element.render('progress'); //渲染新加的进度条组件
                    });
                }
                , done: function (res, index, upload) { //成功的回调
                    var that = this;
                    console.log(res);
                    if(res.code == 0){ //上传成功
                        var tr = that.elemList.find('tr#upload-' + index)
                            , tds = tr.children();
                        tds.eq(3).html('上传成功'); //清空操作
                        delete this.files[index]; //删除文件队列已经上传成功的文件
                        return;
                    }
                    this.error(index, upload);
                }
                , allDone: function (obj) { //多文件上传完毕后的状态回调
                    console.log(obj)
                }
                , error: function (index, upload) { //错误回调
                    var that = this;
                    var tr = that.elemList.find('tr#upload-' + index)
                        , tds = tr.children();
                    tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
                }
                , progress: function (n, elem, e, index) { //注意：index 参数为 layui 2.6.6 新增
                    element.progress('progress-demo-' + index, n + '%'); //执行进度条。n 即为返回的进度百分比
                }
            });

            var uploadListIns_details = upload.render({
                elem: '#testList_2'
                , elemList: $('#demoList_2') //列表元素对象
                , url: '/picture/'+id+'/2' //上传接口
                // , url: 'https://httpbin.org/post' //测试上传接口
                , accept: 'file'
                , multiple: true
                , number: 2
                , auto: false
                , exts: 'jpg|png|gif|bmp|jpeg|avif|webp'
                , bindAction: '#testListAction_2'
                , choose: function (obj) {
                    let i = 1;
                    console.log(obj);
                    var that = this;
                    var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                    //读取本地文件
                    obj.preview(function (index, file, result) {
                        console.log('文件i'+i)
                        i = i+1;
                        // obj.resetFile(index, file, '1.jpg')
                        var tr = $(['<tr id="upload-' + index + '">'
                            , '<td>' + file.name + '</td>'
                            , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                            , '<td><div class="layui-progress" lay-filter="progress-demo-' + index + '"><div class="layui-progress-bar" lay-percent=""></div></div></td>'
                            , '<td>'
                            , '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                            , '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                            , '</td>'
                            , '</tr>'].join(''));

                        //单个重传
                        tr.find('.demo-reload').on('click', function () {
                            obj.upload(index, file);
                        });

                        //删除
                        tr.find('.demo-delete').on('click', function () {
                            delete files[index]; //删除对应的文件
                            tr.remove();
                            uploadListIns_details.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                        });

                        that.elemList.append(tr);
                        element.render('progress'); //渲染新加的进度条组件
                    });
                }
                , done: function (res, index, upload) { //成功的回调
                    var that = this;
                    console.log(res);
                    if(res.code == 0){ //上传成功
                        var tr = that.elemList.find('tr#upload-' + index)
                            , tds = tr.children();
                        tds.eq(3).html('上传成功'); //清空操作
                        delete this.files[index]; //删除文件队列已经上传成功的文件
                        return;
                    }
                    this.error(index, upload);
                }
                , allDone: function (obj) { //多文件上传完毕后的状态回调
                    console.log(obj)
                }
                , error: function (index, upload) { //错误回调
                    var that = this;
                    var tr = that.elemList.find('tr#upload-' + index)
                        , tds = tr.children();
                    tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
                }
                , progress: function (n, elem, e, index) { //注意：index 参数为 layui 2.6.6 新增
                    element.progress('progress-demo-' + index, n + '%'); //执行进度条。n 即为返回的进度百分比
                }
            });
        }
    });




    let defaultOption = '<option value="0">----- 请选择 -----</option>';

</script>
</body>
</html>